name: Build and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version tag
        id: version
        shell: bash
        run: |
          TAG="v$(date +'%Y.%m.%d')-$(echo ${GITHUB_SHA} | cut -c1-7)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build WeChatMsg
        shell: cmd
        run: >
          pyinstaller --noconfirm --onefile --windowed --uac-admin
          --name "WeChatMsg"
          --paths .
          --add-data "wxManager;wxManager"
          --add-data "exporter;exporter"
          --collect-submodules wxManager
          --collect-submodules exporter
          --collect-submodules google.protobuf
          --collect-submodules docx
          --hidden-import PySide6.QtWidgets
          --hidden-import PySide6.QtCore
          --hidden-import PySide6.QtGui
          --exclude-module PySide6.Qt3DAnimation
          --exclude-module PySide6.Qt3DCore
          --exclude-module PySide6.Qt3DExtras
          --exclude-module PySide6.Qt3DInput
          --exclude-module PySide6.Qt3DLogic
          --exclude-module PySide6.Qt3DRender
          --exclude-module PySide6.QtBluetooth
          --exclude-module PySide6.QtCharts
          --exclude-module PySide6.QtDataVisualization
          --exclude-module PySide6.QtGraphs
          --exclude-module PySide6.QtGraphsWidgets
          --exclude-module PySide6.QtLocation
          --exclude-module PySide6.QtMultimedia
          --exclude-module PySide6.QtMultimediaWidgets
          --exclude-module PySide6.QtNfc
          --exclude-module PySide6.QtPdf
          --exclude-module PySide6.QtPdfWidgets
          --exclude-module PySide6.QtPositioning
          --exclude-module PySide6.QtQml
          --exclude-module PySide6.QtQuick
          --exclude-module PySide6.QtQuick3D
          --exclude-module PySide6.QtQuickControls2
          --exclude-module PySide6.QtQuickWidgets
          --exclude-module PySide6.QtRemoteObjects
          --exclude-module PySide6.QtScxml
          --exclude-module PySide6.QtSensors
          --exclude-module PySide6.QtSerialBus
          --exclude-module PySide6.QtSerialPort
          --exclude-module PySide6.QtSpatialAudio
          --exclude-module PySide6.QtSql
          --exclude-module PySide6.QtStateMachine
          --exclude-module PySide6.QtSvg
          --exclude-module PySide6.QtSvgWidgets
          --exclude-module PySide6.QtTest
          --exclude-module PySide6.QtTextToSpeech
          --exclude-module PySide6.QtWebChannel
          --exclude-module PySide6.QtWebEngineCore
          --exclude-module PySide6.QtWebEngineQuick
          --exclude-module PySide6.QtWebEngineWidgets
          --exclude-module PySide6.QtWebSockets
          --exclude-module PySide6.QtXml
          --exclude-module PySide6.QtOpenGL
          --exclude-module PySide6.QtOpenGLWidgets
          --exclude-module PySide6.QtDesigner
          --exclude-module PySide6.QtHelp
          --exclude-module PySide6.QtHttpServer
          --exclude-module PySide6.QtDBus
          --exclude-module PySide6.QtAxContainer
          --exclude-module PySide6.QtConcurrent
          --exclude-module PySide6.QtPrintSupport
          --exclude-module PySide6.QtUiTools
          --hidden-import pymem
          --hidden-import pymem.process
          --hidden-import yara
          --hidden-import psutil
          --hidden-import win32api
          --hidden-import win32process
          --hidden-import win32com.client
          --hidden-import pythoncom
          --hidden-import Crypto.Cipher.AES
          --hidden-import Crypto.Protocol.KDF
          --hidden-import Crypto.Hash.SHA512
          --hidden-import Crypto.Hash.HMAC
          --hidden-import google.protobuf.json_format
          --hidden-import google.protobuf.descriptor
          --hidden-import google.protobuf.descriptor_pool
          --hidden-import google.protobuf.symbol_database
          --hidden-import google.protobuf.reflection
          --hidden-import zstandard
          --hidden-import lz4.block
          --hidden-import aiofiles
          --hidden-import xmltodict
          --hidden-import lxml.etree
          --hidden-import openpyxl
          --hidden-import docx
          --hidden-import pysilk
          --hidden-import PIL.Image
          --hidden-import bs4
          --hidden-import soupsieve
          --hidden-import dateparser
          main.py

      - name: Verify build
        shell: cmd
        run: |
          dir dist\
          if not exist dist\WeChatMsg.exe (echo ERROR: WeChatMsg.exe not found && exit /b 1)

      - name: Create tag
        shell: bash
        run: |
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: WeChatMsg ${{ steps.version.outputs.tag }}
          body: |
            ## 使用方法

            ### 模式一：自动检测微信并解密导出（需要微信运行中）
            1. 下载 `WeChatMsg.exe`
            2. 确保微信已登录且正在运行
            3. 双击运行（自动请求管理员权限）
            4. 选择「自动检测微信并解密导出」
            5. 点击「一键开始」，自动完成解密+导出
            6. 完成后点击「打开导出目录」查看 HTML 聊天记录

            ### 模式二：仅导出已解密的数据库（无需微信运行）
            1. 选择「仅导出已解密的数据库」
            2. 点击「自动扫描」或「浏览」选择已解密的数据库目录
            3. 点击「一键开始」导出 HTML 聊天记录

            支持微信版本：3.x / 4.0 / 4.1
          files: |
            dist/WeChatMsg.exe
          draft: false
          prerelease: false
